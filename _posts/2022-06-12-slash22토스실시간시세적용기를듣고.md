---
title: "Slash22-토스증권 실시간 시세 적용기를 듣고"

date: 2022-06-12

categories:

  - 글또

tags:

  - 글또, Slash22, 증권

---

# Slash22 - 토스증권 실시간 시세 적용기를 듣고 ...

현재 회사에서 기존에 해오던 일이 아닌 새로운 분야를 개발할 기회가 생겼는데요. 바로 증권 시세 서비스입니다. 이러한 증권 시세 서비스는 증권사, 증권 서비스 회사에서 제공하는 기능인데요. 일반적인 분야가 아니다보니 개발에 대한 정보를 얻기가 매우 어렵습니다. 저 또한 증권 시세 서비스를 개발하며 혼자 끙끙대며 여러가지 고민을 하면서 개발을 진행했습니다.(개발 과정은 다음에 정리해보려고 합니다.)

이번에 토스의 개발자 컨퍼런스인 slash22에서 **토스증권 실시간 시세 적용기**([토스ㅣSLASH 22 - 토스증권 실시간 시세 적용기 - YouTube](https://www.youtube.com/watch?v=WKYE-QtzO6g&t=1s)) 라는 주제로 발표가 진행되었고 제공하는 서비스 바운더리가 다르지만 다른 회사의 시세 데이터에 대한 처리 구조를 조금이나만 확인할 수 있어서 이를 정리해보려고 합니다. 

## 구조도

![스크린샷 2022-06-12 오후 3.51.06.png]({{"/assets/images/slash22-2.png" | relative_url }})

토스증권의 시세 시스템 아키텍처를 보여주고 있습니다. 크게 2가지로 구분될 수 있는데요. 첫번째로 국내시세, 두번째로 해외 시세 입니다. 각각을 나눠서 살펴보려고 합니다.

### 국내시세

토스의 국내 원장은 unix, C 기반으로 개발되어있고 mts 시스템은 java 스택 기반으로 개발되어 있다고 합니다. 국내 원장에서 시세 데이터를 mts 시스템으로 전달하기 위해서 매개체로 Kafka를 사용하고 있다고 합니다.

**여기서부터는 개인적인 생각입니다.** 거래소에서는 다양한 데이터를 제공하고 있습니다. 이러한 데이터들을 TR이라고 부르는데요. 국내시세 Collector에서 이러한 TR들을 수신하고 raw data인 TR을 가공해서 데이터의 성격에 따라서 MemoryDB, Shared Memory에 저장하고 있을것이라고 생각됩니다. 가공된 데이터중 실제 거래가 성사된 체결데이터는 적절한 가공이 이뤄져서 kafka를 통해서 Websocket서버로  전달되고 다시 Websocket서버에서 사용자에게 전달되지 않을까 생각됩니다. 전통적인 증권 회사와 다른 점은 Kafka를 사용했다는 점이 아닐까 생각됩니다. 이를 통해서 전통적인 시스템과 Java 기반의 채널계 시스템을 효과적이며 유연하게 분리할 수 있지 않을까 싶습니다.

### 해외시세

해외시세의 경우 연합인맥포스에서 해외시세데이터를 전달받고 mysql과 redis에 저장하는 구조로 이뤄져 습니다.

**여기서부터는 개인적인 생각입니다.**  국내시세와 해외시세가 동일한 구조가 아니라 서로 다른 기술로 만들어져 있는데요. 아마도 해외시세 서비스의 경우는 토스 내부적으로 모던한 기술스택을 이용해서 개발을 진했했고 국내시세의 경우 외부 협력업체에서 개발을 진행해서 전통적인 구조를 가지고 있지 않을까 추측됩니다.(코스콤 원장 외주 참조, [“쉬운 투자” 지향하는 토스증권의 비결 - Byline Network](https://byline.network/2021/06/14-154/)) kafka 이후부터는 동일한 구조를 가지고 있는데요. 아마도 향후에 국내시세 부분도 해외시세 구조와 비슷한 기술스택으로 개선해나아가지 않을까 추측해봅니다. 데이터의 성격에 따라서 mysql과 같은 rdb 그리고 redis와 같은 메모리디비로 구분해서 저장할 수 있을 것으로 생각되는데요. 시시각각 바뀌는 현재가격, 최고가, 최저가, 거래량, 거래대금 등과 같은 데이터는 메모리디비에 저장할듯 싶고 히스토리를 기록해야되는 데이터(차트 데이터, 특정 시간의 가격 등)과 같은 데이터는 rdb에 기록할 수 있을듯 싶습니다. 많은 전통적인 회사에서 Shared Memory를 활용해서 데이터를 저장하고 있는 것으로 알고 있는데요. 개인적으로 토스증권에서 국내 시세 부분도 redis를 도입해서 모던하게 해결할 수 있다는걸 보여줬으면 좋겠습니다.

## 데이터 전달

### WebSocket And Polling

![스크린샷 2022-06-12 오후 3.48.05.png]({{"/assets/images/slash22-1.png" | relative_url }})

토스증권에서는 데이터를 필요할때마다 클라이언트에서 요청해서 가져오는 Polling 방식을 고려했으나 실시간 시세 데이터의 중요성이 부각되어 최신 데이터가 발생할때마다 서버에서 클라이언트로 데이터를 전송하는 WebSocket방식으로 변경했다고 합니다.

Polling 방식을 완전히 폐기하지 않고 오픈 초기 WebSocket 방식에서 문제가 발생하면 Polling 방식으로 fail over될 수 있도록 구성하여 시세 시스템을 안정적으로 운영할 수 있었다고 합니다.

이 2가지 방식을 토스증권 구조도에서도 확인할 수 있습니다.

1. Kafka -> 시세 Realtime -> WebSocket -> Toss App

2. Kafka -> 시세 Gateway -> HTTP API -> Toss APP

### 시세 수신 과정

![스크린샷 2022-06-12 오후 3.57.20.png]({{"/assets/images/slash22-3.png" | relative_url }})

WebSocket을 통해서 시세를 수신하는 과정은 위 그림을 통해서 이해할 수 있습니다.

## 확장성

토스증권의 실시간 시세 시스템은 On-Premise 환경에서 구축되어 있습니다. 아무래도 사용자의 트래픽 증가에 따라서 인프라적으로 유연하게 대응할 수 없는데요. 이러한 문제를 해결하기 위해서 AWS로의 이전을 고려하고 있다고 합니다.

한국거래소에서 제공받은 시세 데이터를 On-premise 서버에서 수신하고 이를 다시 AWS 인프라로 전달하고 AWS에서 클라이언트로 전달하게 되었을때 기존 대비 지연이 발생하지 않을까 생각되는데요. 이를 어떻게 계측하고 해결하는지도 궁금해집니다.

## 정리

실시간 시세라는 기능이 일반적인 도메인에서 사용하는 기능이 아니다보니 여러 회사에서 어떻게 구현하고 구조를 가져가는지 궁금했었는데요. 토스의 이번 발표를 통해서 아키텍처, 그리고 Websocket과 같은 전달방식을 도입하면서 발생할 수 있는 문제점과 해결방법을 간접적으로 확인할 수 있었습니다. 향후 실시간 시세를 고도화 또는 도입했을때 고려해볼 수 있는 부분은 아래와 같습니다.

1. 클라이언트에 데이터 전달시 Polling 방식과 push 방식(WebSocket, SSE)을 상호보완적으로 도입하여 더욱 안정적인 구조를 가져감

2. Push 방식에는 WebSocket과 SSE를 고려해볼 수 있음. 확장성에서는 WebSocket이 더 나은 선택일 수 있으나 다양한 이슈가 발생할 수 있으니 심플한 실시간 시세 기능에서는 SSE도 좋은 선택

3. Kafka와 같은 메세지 큐를 도입하면 데이터 유실에 대응할 수 있고 유연한 구조를 가져갈 수 있을듯 함

4. 사용자 증가에 대한 On-Premise에서 인프라 확장성 한계를 극복하기 위해서 클라이언트에게 데이터를 전달하는 매체쪽 서버들은 aws로 이전을 고려할 수 있음
